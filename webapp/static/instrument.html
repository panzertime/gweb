<head>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script type="text/javascript" src="jquery.jplayer.min.js"></script>
  <link type="text/css" href="blue.monday/css/jplayer.blue.monday.min.css" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      $("#jquery_jplayer_1").jPlayer({
        ready: undefined,
        cssSelectorAncestor: "#jp_container_1",
        swfPath: "/js",
        supplied: "mp3",
        useStateClassSkin: true,
        autoBlur: false,
        smoothPlayBar: true,
        keyEnabled: true,
        remainingDuration: true,
        toggleDuration: true
      });
    });
  </script>

  <script type="text/javascript">
    var model = { "pods": {}, "queued": "", "pages": {} , "selected": {}, "curr_page" : {}};

    $(document).on("change", "#pod-selector", function (e) {
      sel = $("#pod-selector").find(':selected').val();
			model["selected"]["podcast"] = sel;
      url = model["pods"][sel]["cover_url"];
      doc = '<img src="' + url + '" class="img-fluid">';
      $("#pod-cover").html(doc);
			
			$("#page-selector").empty().append("<option selected>Pick a page</option>");
			for (let page = 1; page <= model["pages"][sel]; page++) {
				line = '<option value="' + page + '"> Page ' + page + '</option>';
				$("#page-selector").append(line);
			}
			$("#page-selector").prop("disabled", false);
    });


		$(document).on("change", "#page-selector", function (e) {
			sel_page = $("#page-selector").find(':selected').val();
			const xhttp = new XMLHttpRequest();
      xhttp.overrideMimeType("application/json");
      xhttp.onload = function () {
        var res = JSON.parse(xhttp.responseText);
				model["curr_page"] = res;
        for (episode in res) {

          name = res[episode]["title"];
          line = '<option value="' + episode + '">' + name + '</option>';
          $("#episode-page").append(line);
        }
      }
	  	url = "../get_episodes?podcast=" + model["selected"]["podcast"] + "&page=" + sel_page;
      xhttp.open("GET", url, true);
			$("#episode-page").empty().append("<option selected>Pick an episode</option>");
      xhttp.send();
			$("#episode-page").prop("disabled", false);
		});

		$(document).on("change", "#episode-page", function (e) {
			sel_ep = $("#episode-page").find(':selected').val();
			episode = model["curr_page"][sel_ep];
			model["selected"]["episode"] = episode["id"];
			model["selected"]["title"] = episode["title"];
			desc = episode["description"];
			date = new Date(episode["published"] * 1000).toLocaleString();
			title = episode["title"];

			$("#ep-title").html(title);
			$("#ep-date").html(date);
			$("#ep-desc").html(desc);
			$("#play").prop("disabled", false);
		});

		$(document).on("click", "#play", function (e) {
			const xhttp = new XMLHttpRequest();
      xhttp.overrideMimeType("text/text");
      xhttp.onload = function () {
        var res = xhttp.responseText;
				media = {title: model["title"], mp3: res}
        $("#jquery_jplayer_1").jPlayer("setMedia", media);
      }
      const ep = model["selected"]["episode"];
      xhttp.open("GET", "../queue_episode?id=" + ep, true);
      xhttp.send();
		})

    $(document).ready(function () {
      const xhttp = new XMLHttpRequest();
      xhttp.overrideMimeType("application/json");
      xhttp.onload = function () {
        var res = JSON.parse(xhttp.responseText);
        model["pods"] = res;
        for (pod in res) {
          name = res[pod].title;
          line = '<option value="' + pod + '">' + name + '</option>';
          $("#pod-selector").append(line);
        }
      }
      xhttp.open("GET", "../pods", true);
      xhttp.send();
	    
	 		const xhttp2 = new XMLHttpRequest();
	  	xhttp2.overrideMimeType("application/json");
	  	xhttp2.onload = function () {
				var res = JSON.parse(xhttp2.responseText);
				model["pages"] = {};
				for (pod in res) {
					model["pages"][pod] = Math.ceil(res[pod] / 25);
				}
			}
			xhttp2.open("GET", "../episode_count");
			xhttp2.send();
    });
  </script>

</head>

<body>
  <div class="container grid gap-0 row-gap-3" id="gadgets-wrapper">
    <div class="row">
      <h1>gWeb instruments</h1>
    </div>
    <div class="row">
      <div class="col-8">
        <select class="form-select" id="pod-selector">
          <option selected>Pick a show</option>
        </select>
				<select class="form-select" id="page-selector" disabled>
					<option selected>Pick a page</option>
				</select>
				<select class="form-select" id="episode-page" disabled>
					<option selected>Pick an episode</option>
				</select>
      </div>
      <div class="col-4">
        <div id="pod-cover">
        </div>
      </div>
    </div>
		<div class="row">
			<div class="col-4">
				<h3 id="ep-title"></h2>
				<h3 id="ep-date"></h2>
			</div>
			<div class="col-8">
				<p id="ep-desc"></p>
			</div>
		</div>
		<div class="row">
			<button id="play" class="btn btn-primary" disabled>Play episode</button>
		</div>
	</div>


    <div class="container">
      <div id="jquery_jplayer_1" class="jp-jplayer"></div>
      <div id="jp_container_1" class="jp-audio" role="application" aria-label="media player">
        <div class="jp-type-single">
          <div class="jp-gui jp-interface">
            <div class="jp-volume-controls">
              <button class="jp-mute" role="button" tabindex="0">mute</button>
              <button class="jp-volume-max" role="button" tabindex="0">max volume</button>
              <div class="jp-volume-bar">
                <div class="jp-volume-bar-value"></div>
              </div>
            </div>
            <div class="jp-controls-holder">
              <div class="jp-controls">
                <button class="jp-play" role="button" tabindex="0">play</button>
                <button class="jp-stop" role="button" tabindex="0">stop</button>
              </div>
              <div class="jp-progress">
                <div class="jp-seek-bar">
                  <div class="jp-play-bar"></div>
                </div>
              </div>
              <div class="jp-current-time" role="timer" aria-label="time">&nbsp;</div>
              <div class="jp-duration" role="timer" aria-label="duration">&nbsp;</div>
              <div class="jp-toggles">
                <button class="jp-repeat" role="button" tabindex="0">repeat</button>
              </div>
            </div>
          </div>
          <div class="jp-details">
            <div class="jp-title" aria-label="title">&nbsp;</div>
          </div>
          <div class="jp-no-solution">
            <span>Update Required</span>
            To play the media you will need to either update your browser to a recent version or update your
            <a href="https://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
          </div>
        </div>
      </div>
    </div>

</body>
